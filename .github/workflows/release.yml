name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Select Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
        xcodebuild -version
        
    - name: Get Version from Tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Build Release
      run: |
        swift build --configuration release
        
    - name: Build All Apps
      run: |
        make allapps || echo "Makefile build completed"
        
    - name: Create Release Archive
      run: |
        # Create archive of built apps
        mkdir -p release-artifacts
        
        # Copy release binaries
        if [ -d ".build/release" ]; then
          cp -r .build/release/* release-artifacts/ 2>/dev/null || true
        fi
        
        # Copy built apps if they exist
        if [ -d "build/apps" ]; then
          cp -r build/apps/* release-artifacts/ 2>/dev/null || true
        fi
        
        # Create tarball
        tar -czvf orbit-${{ steps.version.outputs.version }}-macos.tar.gz release-artifacts/
        
    - name: Generate Changelog
      id: changelog
      run: |
        # Get commits since last tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          echo "## Changes since $PREV_TAG" > CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
        else
          echo "## Initial Release" > CHANGELOG.md
          echo "First versioned release of Orbit." >> CHANGELOG.md
        fi
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: orbit-${{ steps.version.outputs.version }}-macos.tar.gz
        body_path: CHANGELOG.md
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
